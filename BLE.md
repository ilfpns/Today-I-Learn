> Bluetooth Low Energy
> 

---

### BLE 프로토콜 레이어

<img width="639" height="511" alt="image" src="https://github.com/user-attachments/assets/ff28ccd5-c743-40a6-b354-40e73f6aba1b" />

**Physical Layer (PHY)**

물리 계층으로, 실제 블루투스 무선 라디오 주파수를 이용해 통신을 하는 계층으로, 아날로그 신호와 디지털 신호를 변조/복조하는 회로를 포함한다. 기본적으로 2.4GHz 신호를 40개의 채널로 나누어 통신하는 데 그 중세 채널을 Advertising을 위해 나머지는 Data전송을 위해 사용된다

**ㅤ**

**Link Layer**

링크 계층으로, 물리 계층과 인터페이스 하는 부분으로 블루투스의 저전력 사양을 준수하기 위한 타이밍 요구 사항이나 무선 상태를 관리하는 역할을 한다

**ㅤ**

**Host Controller Interface (HCI)**

호스트 계층과 컨트롤러 계층 사이의 인터페이스

**ㅤ**

**Logical Link Control and Adapation Protocol (L2CAP)**

프로토콜 멀티플렉싱 레이어 역할을 한다, 상위 계층에서 여러 프로토콜을 가져와 표준 BLE 패킷을 만들고 해당 패킷을 하위 계층에 전달한다 

**ㅤ**

**Attribute Protocol (ATT)**

서버가 데이터를 클라이언트에 노출하는 방법과 데이터를 구성하는 방법을 정의한다

**ㅤ**

**Generic Attribute Profile (GATT)**

BLE 장치에서 노출하는 데이터의 형식과 장치에서 노출하는 데이터에 엑세스하는 데 필요한 절차를 정의한다

**ㅤ**

**Generic Access Profile (GAP)**

BLE 장치 간에  통신을 적용하는 정의한다

**ㅤ**

**Security Manager (SM)**

BLE 장치 간 통신에 보안을 정의한다

**ㅤ**

### GAP에 정의된 디바이스 간 통신

- Bluetooth  LE 디바이스가 서로 통신을 하려면 채널을 형성해야한다 이 채널을 형성하고 윶하는 방법을 GAP에서 정의한다
- 두 장치가 연결됙고 서로 데이터를 교환하려면 두 분야로 나뉜다

**ㅤ**

- Central (중앙 장치)
    
    ⇒ 일반적으로 스마트폰과 같은 장치이다
    

**ㅤ**

- Peripheral (주변 장치)
    
    ⇒ 심박 센서와 같은 전력 소모가 적은 장치인 경우가 대부분이다
    
    ⇒ 이 연결들은 크게 Advertising/Scan과 Connection 단계로 진행된다
    

**ㅤ**

### 통신 연결

1. 주변 장치가 연결할 준비가 되면 advertising 모드로 들어가고 LE 라디오를 사용하여 기본 advertising 채널 (37, 38, 39)에 advertising 패킷을 브로드캐스팅하여 디바이스가 연결준비가 되어 있음을 알린다

**ㅤ**

1. 주변 장치는 Scanning 상태로 전환하고, 이 세 채널에서 advertising 패킷을 수신한다
    
    **ㅤ**
    
2. 중앙 장치는 일정 간격으로 advertising 채널을 스캔한다, 스캔하는 동안 해당 채널에 advertising을 수신하면 해당 주변 장치를 발견한다

**ㅤ**

1. advertising 패킷을 확인하면 중앙 장치에서 connection requet packet을 전송하여 주변 장치에 대한 연결을 시작한다

**ㅤ**

1. 중앙 장치는 연결에 대한 최종 권한을 가지고 있고 연결을 요청할 때 해당 연결에 대한 방식을 설정하고 주변 장치는 중앙 장치가 정한 연결 방식을 따른다
    
    중앙 장치는 3개의 파라미터로 정보를 전달한다
    
    **ㅤ**
    
    - 연결 간격 : 연결 이벤트 사이의 경과 시간 지정
    - Peripheral Latency : 주변 장치에서 건너뛸 수 있는 연결 이벤트 수 지정
    - 채널 맵 : 37개의 사용 가능한 데이터 채널중 전송에 사용할 채널 지정

**ㅤ**

1. 중앙 장치가 연결을 보내면 연결이 생성된다, 하지만 연결 요청에 대한 응답을 주지는 않는다, 이후 연결 간격으로 설정된 시간 이후 중앙 장치는 데이터를 보내고 주변 장치가 해당 데이터 패킷을 응답으로 다시 보내게 되면 연결이 설정된다

**ㅤ**

<img width="764" height="404" alt="image" src="https://github.com/user-attachments/assets/076dba3b-7a28-472c-a571-e9ac1d795129" />

**ㅤ**

- 연결이 설정되면 두 장치간에 영구적인 데이터를 송수신할 수 있다
- 데이터를 전송할 수 있지만, 그 데이터가 어떤 의미인지는 알 수 없다

### ATT의 역할

⇒ 처음 디바이스 간의 역할을 정의한다

- 서버-클라이언트 모델을 따르는 경우가 대부분이며
- 데이터를 요청하는 쪽이 클라이언트로, 중앙 장치 or 주변 장치 그 어떤 기기나 될 수 있다

**ㅤ**

**ATT 서버의 역할**

⇒ 클라이언트와 공유해야 하는 데이터를 저장하는 데이터베이스 역할을 한다

- 클라이언트가 읽고 쓸 수 있는 방식으로 데이터를 저장
- 클라이언트가 데이터를 엑세스하고 쓰고 읽을 수 있는 메커니즘을 제공함

**ㅤ**

| Handle | UUID  | Value | Permissions |
| --- | --- | --- | --- |
- 핸들 : 16비트 식별자로 클라이언트가 서버의 속성을 참조하는데 사용한다, 참조중 변경되지 않는다
- UUID : 데이터의 유형과 의미를 정의하는 고유한 2바이트 or 16바이트 UUID 식별자이다
- 값 : 저장되는 실제 데이터
- 권한 : 속성 값에 엑세스 하는 데 필요한 권한이나 방법을 설정한다

### BLE 프로토콜 스택 언어

**Profile :** 서로 교환하는 데이터 전체를 profile이란 이름으로 표현함, 이미 만들어진 BLE 응용 규격 이름이거나 사용자 정의 Profile로 표현한다, 문자열로 교환하지 않고 UUID라는 숫자로 교환한다

**ㅤ**

**Service :** Profile을 하나 또는 두 개 이상으로 구분할 때 쓴다

**ㅤ**

**Characteristic :** Service 항목 안에서 서로 교환해야 할 마지막 조각이다, 이 역시 UUID라는 숫자로 표현된다,

- 데이터의 바이트크기
- Read Only
- Write Only

와 같은 정보가 담긴다

**ㅤ**

<img width="488" height="593" alt="image" src="https://github.com/user-attachments/assets/ee60c6a7-ecea-44c2-9fbb-6f3ee23b15d1" />
