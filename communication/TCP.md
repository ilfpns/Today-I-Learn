## Transmission Control Porotocol

**⇒ 서버와 클라이언트간 데이터를 신뢰성 있게 전송하기 위해 만들어진 프로토콜**

아래 3개의 큰 특징과 3개의 작은 특징을 가진다.

1. **신뢰성**
- 신뢰할 수 있는 말단 장치간 데이터를 전송함
    
    → 신뢰성있는 데이터를 전송하기 위해선
    
    손상, 중복, 순서 틀어짐 등의 문제를 통해 전달된 데이터를 복구해야함
    
    이러한 신뢰성을 위해서 적극적 수신, 통지, 재전송 체계를 사용한다
    
1. **흐름 제어**
- TCP 데이터 세그먼트를 송수신하는 컴퓨터는 MCU와 네트워크 대역폭의 차이 때문에 서로 다른 속도로 작동할 수 있다
    
    → 결국 수신자가 처리할 수 있는 것처럼 훨씬 더 빠른 속도로 송신자가 데이터를 보낼 가능성이 높다
    
    TCP는 송신자가 보낸 데이터의 양을 제어하는 흐름 제어 메커니즘을 구현한다
    
1. **다중화**
- TCP는 한 라우터의 많은 프로세서가 TCP통신 서비스를 이용할 수 있다 이를 TCP 다중화 라고 한다
    
    → 네트워크 인터페이스는 IP주소로 식별된다 
    
    하지만 공통된 PC에서 같은 네트워크 인터페이스를 사용하는 프로세스는 IP가 같기에 IP 주소보다 더 많은 정보가 필요하다
    
    TCP는  TCP를 사용하는 응용 프로그램 포트 번호 값을 연계하여 구분함
    
1. 연결형 서비스
    - TCP를 사용하여 데이터를 보내려면 먼저 연결 설정을 해야한다
2. 양방향 운반
    - 하나의 전송로에서 동시에 양방향으로 전송이 가능하다
3. 3-way-handshake
    - 동기화(SYN) 제어 플래그를 이용하며, 3-way-handshake라는 세 메시지를 교환한다

## 3-Way-HandShake

→ TCP 연결은세가지 방법의 핸드쉐이크에 의해 초기화된다

- 순번을 동기화
- 연결의 양측에서의 순번 확인
- TCP윈도우 크기를 교환
- 최대 세그먼트 크기와 같은 기타 TCP 옵션을 교환

**방식**

1. Client 에서 Server에 연결 요청을 위해 SYN데이터를 보낸다
2. Server에서 해당 포트는 LISTEN 상태에서 SYN 데이터를 받고 SYN_RCV로 상태가 변경된다
그리고 요청을 정상적으로 받았다는 대답(ACK)와 Client도 포트를 열어달라는 SYN을 같이 보낸다
3. Client에서는 SYN+ACK를 받고 ESTABLISHED로 상태를 변경하고 서버에 요청을 잘 받았다는 ACK를 전송한다
4. 3번의 통신이 정상적으로 이루어 졌을 때, 서로의 포트가 ESTABLISHED 되면서 연결이 된다

<aside>

연결이나 시작을 위해 설정된 특별한 제어 플래그가 설정된 패킷 (SYN)

</aside>

**데이터의 흐름** 

Client → C

Server → S

SYN(C) → ACK, SYN(S) → ACK(C)

## 4-Way-Handshake

→ 맺어진 TCP 세션을 종료하기 위해 실행되는 절차

1. 클라이언트에서 연결을 종료하는 FIN(ACK)플래그를 보낸다
2. 서버는 일단 ACK를 보내고 자신의 통신이 끝날때까지 기다리며 TIME_WAIT상태가 된다
3. 서버는 통신이 끝나면 연결이 종료되었다고 FIN(ACK)플래그를 보낸다
4. 클라이언트는 확인의 메시지로 ACK를 보낸다

<aside>

Routing지연이나 패킷의 유실로 데이터의 전송이 늦어질수 있다. 그러한 상황에서 데이터는 유실될 수 있기에 빠르게 연결을 끊지 않고 일정시간(디폴트 240초)을 기다리는데 이를 TIME_WAIT 이라고 한다

</aside>

**데이터의 흐름** 

Client → C

Server → S

FIN(C) → ACK(S) → FIN(S) → ACK(C)

## FLAG

### ACK (Ackowledgement)

- 확인응답 필드에 확인응답 번호 값이 셋팅됐음을 알림
    - 1로 셋팅되면, 확인번호 유효함을 뜻함
    - 0로 셋팅되면, 확인번호 미포함
    - SYN세그먼트 전송 이후 모든 세그먼트는 항상 이 비트가 1로 셋팅됨

### PSH (PUSH)

- 버퍼링된 데이터를 가능한 빨리 상위 계층 응용프로그램에 즉시 전달함
    - 수신측은 버퍼가 찰 때까지 기다리지 않고 수진 즉시 버퍼링된 데이터를 응용프로그램에 전달

### SYN (Synchronize)

- 연결 시작, 회선개설 용도
    - 연결요청 : SYN = 1, ACK = 0 (SYN세그먼트)
    - 연결허락 : SYN = 1, ACK = 1 (SYN + ACK세그먼트)
    - 연결설정 : ACK = 0 (ACK세그먼트)
    - 즉 송수신기 간에 순서번호 동기화

### FIN (FINISH)

- 연결 해제, 회선 종결 용도로 송신기가 데이터 보내기를 종료함
    - 종결요청 : FIN = 1 (FIN 세그먼트)
    - 종결응답 : FIN = 1, ACK = 1 (FIN+ACK 세그먼트)
